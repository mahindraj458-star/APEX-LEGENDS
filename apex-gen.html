<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APEX GARAGE | CLOUD EDITION</title>
    <style>
        :root {
            --neon-blue: #00f2ff;
            --dark-bg: #050505;
            --glass: rgba(10, 10, 10, 0.85);
        }
        body, html { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: white; }
        
        /* UI Overlay */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 30px;
            box-sizing: border-box;
        }

        .panel {
            background: var(--glass);
            border-left: 3px solid var(--neon-blue);
            padding: 20px;
            pointer-events: auto;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* Top Bar */
        .header { display: flex; justify-content: space-between; align-items: flex-start; }
        .logo h1 { margin: 0; font-size: 24px; letter-spacing: 5px; color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); }
        .logo p { margin: 0; font-size: 10px; opacity: 0.6; text-transform: uppercase; }

        /* Stats HUD */
        .stats-hud { width: 200px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; }
        .stat-val { color: var(--neon-blue); font-weight: bold; }

        /* Garage Inventory (Cloud) */
        .inventory-panel {
            width: 250px;
            max-height: 400px;
            overflow-y: auto;
        }
        .inventory-panel h3 { margin: 0 0 15px 0; font-size: 14px; letter-spacing: 2px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .car-list-container { max-height: 250px; overflow-y: auto; }
        .car-item {
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.05);
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid transparent;
        }
        .car-item:hover { background: rgba(0, 242, 255, 0.1); border-color: var(--neon-blue); }
        .car-item.active { border-color: var(--neon-blue); background: rgba(0, 242, 255, 0.2); }
        .car-item div { font-size: 11px; opacity: 0.7; }

        /* Controls */
        .controls {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }
        button {
            background: transparent;
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 10px 20px;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 2px;
            transition: 0.3s;
        }
        button:hover { background: var(--neon-blue); color: black; box-shadow: 0 0 20px var(--neon-blue); }
        
        #terminal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
        }
        #terminal-box { width: 80%; max-width: 600px; background: #111; padding: 20px; border: 1px solid var(--neon-blue); }
        textarea { width: 100%; height: 200px; background: #000; color: #0f0; border: 1px solid #333; font-family: monospace; padding: 10px; box-sizing: border-box; resize: none; }
        
        #loading-screen {
            position: fixed; top:0; left:0; width:100%; height:100%; background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
        }
        .spinner { width: 50px; height: 50px; border: 3px solid #111; border-top-color: var(--neon-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading-screen">
    <div class="spinner"></div>
    <p id="loading-text" style="margin-top: 20px; letter-spacing: 5px; color: var(--neon-blue);">INITIALIZING GARAGE</p>
</div>

<div id="terminal-overlay">
    <div id="terminal-box">
        <h2 style="color: var(--neon-blue); margin-top:0;">IMPORT APEX MODEL</h2>
        <p style="font-size: 12px; opacity: 0.7;">Paste the Base64 data from your car's HTML.</p>
        <input type="text" id="car-name-input" placeholder="Vehicle Name (e.g. Tata Nano)" style="width:100%; margin-bottom:10px; padding:8px; background:#000; border:1px solid #333; color:white;">
        <input type="number" id="car-hp-input" placeholder="Horsepower (HP)" style="width:100%; margin-bottom:10px; padding:8px; background:#000; border:1px solid #333; color:white;">
        <textarea id="car-data-input" placeholder="Paste Base64 data here..."></textarea>
        <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button id="save-import-btn">UPLOAD TO CLOUD</button>
            <button onclick="toggleTerminal(false)" style="border-color: #ff4444; color: #ff4444;">CANCEL</button>
        </div>
    </div>
</div>

<div id="ui-layer">
    <div class="header">
        <div class="panel logo">
            <h1>APEX : GARAGE</h1>
            <p id="user-display">Connecting to network...</p>
        </div>
        <div class="panel stats-hud">
            <div class="stat-row"><span>STATUS</span> <span class="stat-val" id="engine-status">OFF</span></div>
            <div class="stat-row"><span>SPEED</span> <span class="stat-val" id="speed-display">0 MPH</span></div>
            <div class="stat-row"><span>MAX POWER</span> <span class="stat-val" id="hp-display">0 HP</span></div>
        </div>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: flex-end;">
        <div class="panel inventory-panel">
            <h3>STORED MODELS</h3>
            <div id="car-list" class="car-list-container">
                <p style="font-size: 10px; opacity: 0.5;">Loading cloud data...</p>
            </div>
            <button onclick="toggleTerminal(true)" style="width: 100%; margin-top: 10px; font-size: 10px;">+ IMPORT NEW</button>
        </div>

        <div class="controls">
            <button id="ignite-btn">Ignition</button>
        </div>
    </div>
</div>

<!-- Three.js (Must load before custom script) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CONFIG & INIT ---
    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'apex-garage-v1';

    let user = null;
    let currentCar = null;
    let scene, camera, renderer, loader;
    let engineRunning = false;
    let speed = 0;
    let targetSpeed = 0;
    let hpValue = 0;

    // --- THREE.JS SETUP ---
    function initThree() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050505);
        scene.fog = new THREE.Fog(0x050505, 10, 50);

        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(6, 3, 10);
        camera.lookAt(0, 1, 0);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ReinhardToneMapping;
        renderer.toneMappingExposure = 2.0;
        document.body.appendChild(renderer.domElement);

        const sun = new THREE.DirectionalLight(0xffffff, 4);
        sun.position.set(5, 10, 5);
        scene.add(sun);

        const ambient = new THREE.AmbientLight(0x404040, 1);
        scene.add(ambient);

        const grid = new THREE.GridHelper(100, 100, 0x00f2ff, 0x222222);
        scene.add(grid);

        const floorGeo = new THREE.PlaneGeometry(100, 100);
        const floorMat = new THREE.MeshStandardMaterial({ color: 0x080808, roughness: 0.1, metalness: 0.5 });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);

        loader = new THREE.GLTFLoader();
        animate();
    }

    function animate() {
        requestAnimationFrame(animate);
        if (engineRunning) {
            speed = THREE.MathUtils.lerp(speed, targetSpeed, 0.05);
            if (currentCar) {
                currentCar.position.z -= speed * 0.01;
                camera.position.z = currentCar.position.z + 10;
                camera.lookAt(currentCar.position.x, 1, currentCar.position.z);
            }
        }
        document.getElementById('speed-display').innerText = Math.round(speed) + " MPH";
        renderer.render(scene, camera);
    }

    // --- CAR MANAGEMENT ---
    async function loadCarModel(base64Data, carHp) {
        if (currentCar) scene.remove(currentCar);
        
        hpValue = carHp;
        document.getElementById('hp-display').innerText = hpValue + " HP";
        
        try {
            const binary = atob(base64Data);
            const array = new Uint8Array(binary.length);
            for(let i=0; i<binary.length; i++) array[i] = binary.charCodeAt(i);
            const blob = new Blob([array], { type: 'model/gltf-binary' });
            const url = URL.createObjectURL(blob);

            loader.load(url, (gltf) => {
                currentCar = gltf.scene;
                scene.add(currentCar);
                document.getElementById('loading-screen').style.display = 'none';
            });
        } catch (err) {
            console.error("Error decoding model:", err);
            document.getElementById('loading-screen').style.display = 'none';
        }
    }

    // --- FIREBASE LOGIC ---
    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (err) {
            console.error("Auth initialization failed:", err);
            document.getElementById('loading-text').innerText = "AUTH ERROR - CHECK CONSOLE";
        }
    };

    onAuthStateChanged(auth, (u) => {
        user = u;
        if (user) {
            document.getElementById('user-display').innerText = "CLOUD ACTIVE: " + user.uid.substring(0,8);
            setupFirestoreListeners();
        }
    });

    function setupFirestoreListeners() {
        if (!user) return;
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'vehicles'));
        
        onSnapshot(q, (snapshot) => {
            const listDiv = document.getElementById('car-list');
            listDiv.innerHTML = '';
            
            if (snapshot.empty) {
                document.getElementById('loading-screen').style.display = 'none';
                listDiv.innerHTML = '<p style="font-size:10px; opacity:0.5;">No cars in cloud. Import one!</p>';
                return;
            }

            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const item = document.createElement('div');
                item.className = 'car-item';
                item.innerHTML = `
                    <strong>${data.name}</strong>
                    <div>${data.hp} HP | V.ID: ${docSnap.id.substring(0,5)}</div>
                `;
                item.onclick = () => {
                    loadCarModel(data.modelData, data.hp);
                    document.querySelectorAll('.car-item').forEach(el => el.classList.remove('active'));
                    item.classList.add('active');
                };
                listDiv.appendChild(item);
            });

            // Auto-load first car if nothing is active
            if (!currentCar) {
                const first = snapshot.docs[0].data();
                loadCarModel(first.modelData, first.hp);
            }
        }, (err) => {
            console.error("Firestore Error:", err);
            document.getElementById('loading-text').innerText = "SYNC ERROR: " + err.code;
        });
    }

    // --- BUTTON ACTIONS ---
    document.getElementById('save-import-btn').addEventListener('click', async () => {
        const name = document.getElementById('car-name-input').value;
        const hpVal = parseInt(document.getElementById('car-hp-input').value);
        const data = document.getElementById('car-data-input').value;

        if (!name || !hpVal || !data) return;
        if (!user) return;

        document.getElementById('save-import-btn').disabled = true;
        document.getElementById('save-import-btn').innerText = "UPLOADING...";

        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'vehicles'), {
                name: name,
                hp: hpVal,
                modelData: data,
                createdBy: user.uid,
                createdAt: serverTimestamp()
            });
            window.toggleTerminal(false);
        } catch (e) {
            console.error(e);
        } finally {
            document.getElementById('save-import-btn').disabled = false;
            document.getElementById('save-import-btn').innerText = "UPLOAD TO CLOUD";
        }
    });

    window.toggleTerminal = (show) => {
        document.getElementById('terminal-overlay').style.display = show ? 'flex' : 'none';
    };

    document.getElementById('ignite-btn').addEventListener('click', () => {
        engineRunning = !engineRunning;
        document.getElementById('engine-status').innerText = engineRunning ? "ON" : "OFF";
        document.getElementById('engine-status').style.color = engineRunning ? "#00f2ff" : "#ff4444";
        if(!engineRunning) targetSpeed = 0;
    });

    window.addEventListener('keydown', (e) => {
        if (!engineRunning) return;
        const maxSpeed = 20 * Math.pow(hpValue || 37, 1/3);
        if (e.key.toLowerCase() === 'w') targetSpeed = maxSpeed;
        if (e.key.toLowerCase() === 's') targetSpeed = 0;
    });

    // Start
    initThree();
    initAuth();
</script>
</body>
</html>
