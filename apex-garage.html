<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APEX PRO // GARAGE ENGINE</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        :root {
            --bg: #030303;
            --accent: #00f2ff;
            --panel: rgba(10, 10, 10, 0.9);
            --border: #222;
            --font-mono: 'Syncopate', sans-serif;
            --font-sans: 'Inter', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: white; font-family: var(--font-sans); overflow: hidden; height: 100vh; }

        #canvas-container { position: absolute; inset: 0; z-index: 1; }

        /* UI Overlays */
        .ui-wrapper { position: relative; z-index: 10; height: 100vh; pointer-events: none; display: flex; flex-direction: column; }
        .ui-wrapper > * { pointer-events: auto; }

        .top-bar { padding: 25px; display: flex; justify-content: space-between; align-items: flex-start; }
        .brand h1 { font-family: var(--font-mono); font-size: 0.9rem; letter-spacing: 4px; color: var(--accent); text-shadow: 0 0 15px rgba(0, 242, 255, 0.5); }
        .db-status { font-size: 0.55rem; color: #444; font-family: var(--font-mono); margin-top: 6px; }

        .main-layout { display: flex; flex: 1; padding: 0 25px 25px 25px; gap: 20px; overflow: hidden; }

        /* Sidebar Styling */
        .sidebar { width: 300px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; scrollbar-width: none; }
        .sidebar::-webkit-scrollbar { display: none; }
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 6px; padding: 20px; backdrop-filter: blur(20px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .section-title { font-family: var(--font-mono); font-size: 0.6rem; color: #666; margin-bottom: 15px; letter-spacing: 1px; display: flex; justify-content: space-between; border-bottom: 1px solid #1a1a1a; padding-bottom: 8px; }

        /* Asset Items */
        .asset-list { flex: 1; }
        .asset-item { 
            padding: 12px; border: 1px solid #1a1a1a; margin-bottom: 10px; border-radius: 4px; 
            cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background: #080808;
            display: flex; align-items: center; gap: 12px;
        }
        .asset-item:hover { border-color: var(--accent); background: #111; transform: translateX(5px); }
        .asset-item.active { border-color: var(--accent); background: rgba(0, 242, 255, 0.05); border-left: 4px solid var(--accent); }
        .asset-item .mini-preview { width: 40px; height: 40px; background: #000; border-radius: 3px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid #222; }
        .asset-item .mini-preview img { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; }
        .asset-item-info h4 { font-size: 0.65rem; font-family: var(--font-mono); margin-bottom: 2px; color: #eee; }
        .asset-item-info p { font-size: 0.55rem; color: #555; }

        /* Visual Snapshot / Details */
        .visual-preview-box { 
            width: 100%; height: 160px; background: #000; border-radius: 4px; margin-bottom: 15px;
            border: 1px solid #222; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        #snapshot-img { max-width: 100%; max-height: 100%; object-fit: contain; filter: drop-shadow(0 0 10px rgba(0,242,255,0.2)); }
        .scanline { position: absolute; inset: 0; background: linear-gradient(to bottom, transparent 50%, rgba(0, 242, 255, 0.02) 50%); background-size: 100% 4px; pointer-events: none; }

        /* Inputs */
        .spec-input { background: #000; border: 1px solid #222; color: #fff; padding: 10px; width: 100%; margin-bottom: 12px; font-size: 0.75rem; border-radius: 3px; font-family: var(--font-sans); }
        .spec-input:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 10px rgba(0, 242, 255, 0.1); }
        label { font-size: 0.55rem; color: #555; display: block; margin-bottom: 5px; font-family: var(--font-mono); letter-spacing: 1px; }

        .drop-zone {
            border: 2px dashed #222; border-radius: 6px; padding: 35px 20px;
            text-align: center; cursor: pointer; transition: 0.3s; background: rgba(255,255,255,0.01);
        }
        .drop-zone:hover, .drop-zone.dragover { border-color: var(--accent); background: rgba(0, 242, 255, 0.05); }
        .drop-zone p { font-family: var(--font-mono); font-size: 0.55rem; color: #666; margin-top: 10px; line-height: 1.5; }

        .btn {
            width: 100%; padding: 14px; background: #0a0a0a; border: 1px solid #333;
            color: white; font-family: var(--font-mono); font-size: 0.65rem;
            cursor: pointer; transition: 0.2s; text-transform: uppercase; border-radius: 4px;
        }
        .btn:hover { border-color: var(--accent); background: #111; color: var(--accent); }
        .btn.primary { background: var(--accent); color: black; border: none; font-weight: bold; margin-top: 10px; box-shadow: 0 4px 15px rgba(0, 242, 255, 0.3); }
        .btn.primary:hover { background: #00dce8; color: black; transform: translateY(-2px); }

        #notify { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #000; border: 1px solid var(--accent); color: var(--accent); padding: 12px 30px;
            font-family: var(--font-mono); font-size: 0.65rem; border-radius: 40px;
            display: none; z-index: 1000; box-shadow: 0 0 20px rgba(0,242,255,0.2);
        }

        .empty-state { color: #333; font-size: 0.6rem; text-align: center; padding: 40px 20px; font-family: var(--font-mono); }
    </style>
</head>
<body>

    <div id="notify">SYSTEM_MESSAGE</div>
    <div id="canvas-container"></div>

    <div class="ui-wrapper">
        <div class="top-bar">
            <div class="brand">
                <h1>APEX_PRO // GARAGE</h1>
                <div class="db-status" id="db-status">CONNECTING_LOCAL_DB...</div>
            </div>
        </div>

        <div class="main-layout">
            <!-- Left Side: Local List & Upload -->
            <div class="sidebar">
                <div class="panel">
                    <div class="section-title">
                        <span>LOCAL_STORAGE</span>
                        <span id="count" style="color:var(--accent)">0</span>
                    </div>
                    <div class="asset-list" id="asset-list">
                        <div class="empty-state">NO_MODELS_DETECTED</div>
                    </div>
                </div>

                <div class="panel">
                    <div class="section-title">IMPORT_ENGINE</div>
                    <div class="drop-zone" id="drop-zone">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:var(--accent);"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
                        <p>CLICK TO BROWSE<br><span style="color:#444">OR DROP .GLB</span></p>
                        <input type="file" id="file-input" hidden accept=".glb,.gltf">
                    </div>
                </div>
            </div>

            <div style="flex:1"></div>

            <!-- Right Side: Model Specs & Visual -->
            <div class="sidebar">
                <div class="panel" id="profile-panel" style="opacity: 0.5; pointer-events: none;">
                    <div class="section-title">VEHICLE_VISUAL</div>
                    
                    <div class="visual-preview-box">
                        <div class="scanline"></div>
                        <img id="snapshot-img" src="" style="display:none">
                        <div id="snap-placeholder" style="font-size:0.5rem; color:#333; font-family:var(--font-mono)">WAITING_FOR_DATA...</div>
                    </div>

                    <div class="section-title">SPECS_MODULE</div>
                    
                    <label>VEHICLE NAME</label>
                    <input type="text" id="car-name" class="spec-input" placeholder="DESIGNATION">
                    
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1">
                            <label>POWER (HP)</label>
                            <input type="text" id="car-hp" class="spec-input" placeholder="---">
                        </div>
                        <div style="flex:1">
                            <label>0-60 MPH</label>
                            <input type="text" id="car-speed" class="spec-input" placeholder="0.0S">
                        </div>
                    </div>

                    <label>CHASSIS / DRIVE</label>
                    <input type="text" id="car-drive" class="spec-input" placeholder="SYSTEM_SPEC">

                    <button class="btn primary" onclick="saveCurrentSpecs()">SAVE_CONFIG_CHANGES</button>
                </div>

                <div class="panel">
                    <div class="section-title">UTILITIES</div>
                    <button class="btn" onclick="exportPackage()" id="export-btn" disabled>EXPORT_STANDALONE</button>
                    <button class="btn" style="margin-top:10px; border-color: #311; color:#522;" onclick="clearStorage()">WIPE_DATABASE</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let scene, camera, renderer, controls, currentModel, db;
        let activeId = null;

        const DB_NAME = "ApexGarageDB_V3";
        const STORE_NAME = "Vehicles";

        // --- DATABASE ---
        async function initDB() {
            return new Promise((resolve) => {
                const request = indexedDB.open(DB_NAME, 3);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: "id", autoIncrement: true });
                    }
                };
                request.onsuccess = (e) => {
                    db = e.target.result;
                    document.getElementById('db-status').innerText = "SYSTEM_STATUS: ONLINE // DB_READY";
                    refreshList();
                    resolve();
                };
            });
        }

        async function saveModelToDB(buffer, name, thumb) {
            const tx = db.transaction(STORE_NAME, "readwrite");
            const item = {
                name: name,
                data: buffer,
                thumb: thumb,
                specs: { hp: "", speed: "", drive: "" },
                timestamp: Date.now()
            };
            const request = tx.objectStore(STORE_NAME).add(item);
            request.onsuccess = (e) => {
                activeId = e.target.result;
                refreshList();
                showNotify("ENTRY_CREATED_SUCCESSFULLY");
            };
        }

        async function refreshList() {
            const tx = db.transaction(STORE_NAME, "readonly");
            const request = tx.objectStore(STORE_NAME).getAll();
            
            request.onsuccess = () => {
                const list = document.getElementById('asset-list');
                const items = request.result;
                document.getElementById('count').innerText = items.length;

                if (items.length === 0) {
                    list.innerHTML = '<div class="empty-state">NO_MODELS_DETECTED</div>';
                    return;
                }

                list.innerHTML = '';
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = `asset-item ${activeId === item.id ? 'active' : ''}`;
                    div.innerHTML = `
                        <div class="mini-preview">${item.thumb ? `<img src="${item.thumb}">` : ''}</div>
                        <div class="asset-item-info">
                            <h4>${item.name.toUpperCase()}</h4>
                            <p>${(item.data.byteLength / 1024 / 1024).toFixed(1)}MB // SECURE</p>
                        </div>
                    `;
                    div.onclick = () => loadModelFromItem(item);
                    list.appendChild(div);
                });
            };
        }

        // --- 3D ENGINE ---
        function init3D() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x030303);
            scene.fog = new THREE.Fog(0x030303, 10, 50);

            camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(10, 5, 10);

            renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.shadowMap.enabled = true;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.maxPolarAngle = Math.PI / 2.1;

            // Lights
            const ambient = new THREE.AmbientLight(0xffffff, 0.3);
            scene.add(ambient);

            const hemi = new THREE.HemisphereLight(0x00f2ff, 0xff00ff, 0.2);
            scene.add(hemi);

            const topLight = new THREE.DirectionalLight(0xffffff, 1.2);
            topLight.position.set(5, 10, 5);
            topLight.castShadow = true;
            scene.add(topLight);

            // Floor
            const grid = new THREE.GridHelper(100, 80, 0x111111, 0x080808);
            scene.add(grid);

            const floorGeo = new THREE.PlaneGeometry(200, 200);
            const floorMat = new THREE.MeshStandardMaterial({ color: 0x030303, roughness: 0.1, metalness: 0.5 });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // --- FILE OPS ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => e.target.files[0] && handleFile(e.target.files[0]);

        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
        dropZone.ondragleave = () => dropZone.classList.remove('dragover');
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
        };

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const buffer = e.target.result;
                await loadModelFromBuffer(buffer);
                const thumb = captureSnapshot();
                saveModelToDB(buffer, file.name, thumb);
            };
            reader.readAsArrayBuffer(file);
        }

        function captureSnapshot() {
            renderer.render(scene, camera);
            return renderer.domElement.toDataURL('image/webp', 0.5);
        }

        async function loadModelFromBuffer(buffer) {
            if (currentModel) scene.remove(currentModel);
            
            return new Promise((resolve) => {
                const loader = new THREE.GLTFLoader();
                loader.parse(buffer, '', (gltf) => {
                    currentModel = gltf.scene;
                    
                    const box = new THREE.Box3().setFromObject(currentModel);
                    const center = box.getCenter(new THREE.Vector3());
                    
                    currentModel.position.x += (currentModel.position.x - center.x);
                    currentModel.position.z += (currentModel.position.z - center.z);
                    currentModel.position.y -= box.min.y;
                    
                    scene.add(currentModel);
                    
                    // Auto-focus camera
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    camera.position.set(maxDim * 1.5, maxDim * 0.8, maxDim * 1.5);
                    controls.target.set(0, size.y / 2, 0);

                    // Enable UI
                    document.getElementById('profile-panel').style.opacity = "1";
                    document.getElementById('profile-panel').style.pointerEvents = "auto";
                    document.getElementById('export-btn').disabled = false;

                    resolve();
                });
            });
        }

        async function loadModelFromItem(item) {
            activeId = item.id;
            await loadModelFromBuffer(item.data);
            
            // Snapshot & UI Sync
            const snapImg = document.getElementById('snapshot-img');
            snapImg.src = item.thumb || "";
            snapImg.style.display = item.thumb ? "block" : "none";
            document.getElementById('snap-placeholder').style.display = item.thumb ? "none" : "block";

            document.getElementById('car-name').value = item.name;
            document.getElementById('car-hp').value = item.specs?.hp || "";
            document.getElementById('car-speed').value = item.specs?.speed || "";
            document.getElementById('car-drive').value = item.specs?.drive || "";
            
            refreshList();
        }

        async function saveCurrentSpecs() {
            if (!activeId) return;
            
            const tx = db.transaction(STORE_NAME, "readwrite");
            const store = tx.objectStore(STORE_NAME);
            
            const item = await new Promise(r => store.get(activeId).onsuccess = e => r(e.target.result));
            
            item.name = document.getElementById('car-name').value;
            item.specs = {
                hp: document.getElementById('car-hp').value,
                speed: document.getElementById('car-speed').value,
                drive: document.getElementById('car-drive').value
            };
            // Update thumb to latest angle
            item.thumb = captureSnapshot();
            
            store.put(item);
            showNotify("CONFIG_STORED_TO_MEMORY");
            refreshList();
        }

        function exportPackage() {
            if (!activeId) return;
            showNotify("PREPARING_EXPORT...");
            // Export logic remains same as previous version but with new spec UI
            // Implementation omitted for brevity to focus on the Visual Model feature
            const tx = db.transaction(STORE_NAME, "readonly");
            tx.objectStore(STORE_NAME).get(activeId).onsuccess = (e) => {
                const item = e.target.result;
                const base64Data = btoa(new Uint8Array(item.data).reduce((data, byte) => data + String.fromCharCode(byte), ''));
                const html = `<!DOCTYPE html><html><head><title>APEX: ${item.name}</title><style>body{margin:0;background:#000;color:#00f2ff;font-family:sans-serif;}#ui{position:absolute;top:30px;left:30px;background:rgba(0,0,0,0.8);padding:20px;border:1px solid #222;border-left:4px solid #00f2ff;}h1{margin:0;font-size:16px;letter-spacing:3px;}p{font-size:11px;opacity:0.6;margin-top:10px;}</style></head><body><div id="ui"><h1>${item.name.toUpperCase()}</h1><p>HP: ${item.specs.hp} | 0-60: ${item.specs.speed} | DRIVE: ${item.specs.drive}</p></div><script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"><\/script><script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"><\/script><script>const scene=new THREE.Scene();const camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,0.1,1000);const renderer=new THREE.WebGLRenderer({antialias:true});renderer.setSize(window.innerWidth,window.innerHeight);document.body.appendChild(renderer.domElement);scene.add(new THREE.AmbientLight(0xffffff,0.8));const bin=atob("${base64Data}");const arr=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)arr[i]=bin.charCodeAt(i);new THREE.GLTFLoader().parse(arr.buffer,'',(g)=>{scene.add(g.scene);camera.position.set(5,3,5);camera.lookAt(0,0,0);function anim(){requestAnimationFrame(anim);g.scene.rotation.y+=0.005;renderer.render(scene,camera);}anim();});<\/script></body></html>`;
                const blob = new Blob([html], {type:'text/html'});
                const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`APEX_${item.name.replace(/\s+/g,'_')}.html`; a.click();
            };
        }

        function showNotify(msg) {
            const n = document.getElementById('notify');
            n.innerText = msg; n.style.display = 'block';
            setTimeout(() => n.style.display = 'none', 3000);
        }

        function clearStorage() {
            if(confirm("THIS WILL WIPE ALL MODELS. PROCEED?")) {
                indexedDB.deleteDatabase(DB_NAME);
                location.reload();
            }
        }

        window.onload = () => { init3D(); initDB(); };
        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
